<section class="budget-list">
  <header class="budget-list__header">
    <div class="budget-list__intro">
      <h1>Budgets</h1>
      <p>
        Visualisez vos enveloppes financières et identifiez rapidement les budgets à surveiller.
      </p>
    </div>

    <div class="budget-list__actions">
      <button
        type="button"
        class="budget-list__refresh"
        (click)="refreshBudgets()"
        [disabled]="isLoading()"
      >
        Actualiser
      </button>
    </div>
  </header>

  <section class="budget-list__alert" *ngIf="!isLoading() && error() as errorMessage">
    <h2>Impossible de charger les budgets</h2>
    <p>{{ errorMessage }}</p>
  </section>

  <section class="budget-list__summary" *ngIf="summary() as stats">
    <div class="budget-list__summary-card">
      <span class="budget-list__summary-label">Budgets actifs</span>
      <strong class="budget-list__summary-value">{{ stats.budgetsCount }}</strong>
    </div>
    <div class="budget-list__summary-card">
      <span class="budget-list__summary-label">Montant alloué</span>
      <strong class="budget-list__summary-value">
        {{ stats.totalAllocated | currency: stats.currency }}
      </strong>
    </div>
    <div class="budget-list__summary-card">
      <span class="budget-list__summary-label">Dépenses engagées</span>
      <strong class="budget-list__summary-value">
        {{ stats.totalSpent | currency: stats.currency }}
      </strong>
    </div>
    <div class="budget-list__summary-card">
      <span class="budget-list__summary-label">Disponible</span>
      <strong
        class="budget-list__summary-value"
        [class.budget-list__summary-value--negative]="stats.totalRemaining < 0"
      >
        {{ stats.totalRemaining | currency: stats.currency }}
      </strong>
    </div>
    <div class="budget-list__summary-card">
      <span class="budget-list__summary-label">Sur la bonne voie</span>
      <strong class="budget-list__summary-value">{{ stats.onTrackCount }}</strong>
    </div>
    <div class="budget-list__summary-card">
      <span class="budget-list__summary-label">Sous surveillance</span>
      <strong class="budget-list__summary-value">{{ stats.atRiskCount }}</strong>
    </div>
    <div class="budget-list__summary-card">
      <span class="budget-list__summary-label">Budgets dépassés</span>
      <strong class="budget-list__summary-value">{{ stats.exceededCount }}</strong>
    </div>
  </section>

  <p class="budget-list__updated" *ngIf="lastUpdatedAt() as updated">
    Dernière mise à jour : {{ updated | date: 'medium' }}
  </p>

  <div class="budget-list__loader" *ngIf="isLoading()">
    <span class="budget-list__spinner" aria-hidden="true"></span>
    <p>Chargement des budgets…</p>
  </div>

  <section class="budget-list__empty" *ngIf="!isLoading() && !budgets().length">
    <h2>Aucun budget défini</h2>
    <p>
      Créez votre premier budget pour suivre vos dépenses et atteindre vos objectifs financiers.
    </p>
  </section>

  <section class="budget-list__grid" *ngIf="budgets().length">
    <article
      class="budget-card"
      *ngFor="let budget of budgets(); trackBy: trackByBudgetId"
      [class.budget-card--warning]="budget.status === 'at-risk'"
      [class.budget-card--danger]="budget.status === 'over-budget'"
    >
      <header class="budget-card__header">
        <div>
          <h2>
            <a [routerLink]="['/budgets', budget.id]">{{ budget.name }}</a>
          </h2>
          <p class="budget-card__meta">
            {{ budget.category }} • {{ budget.period | titlecase }}
          </p>
        </div>

        <span
          class="budget-card__badge"
          [attr.aria-label]="statusMetadata[budget.status].description"
          [class.budget-card__badge--success]="budget.status === 'on-track'"
          [class.budget-card__badge--warning]="budget.status === 'at-risk'"
          [class.budget-card__badge--danger]="budget.status === 'over-budget'"
        >
          {{ statusMetadata[budget.status].label }}
        </span>
      </header>

      <div class="budget-card__amounts">
        <dl>
          <div class="budget-card__stat">
            <dt>Alloué</dt>
            <dd>{{ budget.amount | currency: budget.currency }}</dd>
          </div>
          <div class="budget-card__stat">
            <dt>Dépensé</dt>
            <dd>{{ budget.spent | currency: budget.currency }}</dd>
          </div>
          <div class="budget-card__stat">
            <dt>Disponible</dt>
            <dd [class.budget-card__amount--negative]="getRemainingAmount(budget) < 0">
              {{ getRemainingAmount(budget) | currency: budget.currency }}
            </dd>
          </div>
        </dl>
      </div>

      <div
        class="budget-card__progress"
        role="progressbar"
        aria-valuemin="0"
        [attr.aria-valuenow]="budget.spent"
        [attr.aria-valuemax]="budget.amount"
      >
        <div class="budget-card__progress-bar" [style.width.%]="getBudgetProgress(budget)"></div>
      </div>
      <p class="budget-card__progress-label">
        {{ (budget.amount ? budget.spent / budget.amount : 0) | percent: '1.0-0' }} du budget utilisé
      </p>

      <ul class="budget-card__alerts" *ngIf="budget.alerts?.length">
        <li *ngFor="let alert of budget.alerts">
          <span
            class="budget-card__alert-indicator"
            [class.budget-card__alert-indicator--info]="alert.severity === 'info'"
            [class.budget-card__alert-indicator--warning]="alert.severity === 'warning'"
            [class.budget-card__alert-indicator--critical]="alert.severity === 'critical'"
            aria-hidden="true"
          ></span>
          <span class="budget-card__alert-message">{{ alert.message }}</span>
        </li>
      </ul>

      <footer class="budget-card__footer">
        <span class="budget-card__period">
          Période : {{ budget.startDate | date: 'MMM y' }} – {{ budget.endDate ? (budget.endDate | date: 'MMM y') : 'en cours' }}
        </span>
        <a
          class="budget-card__link"
          [routerLink]="['/budgets', budget.id]"
          aria-label="Consulter le budget {{ budget.name }}"
        >
          Détails du budget
        </a>
      </footer>
    </article>
  </section>
</section>

